# 2段階生成システムと従来方式の比較

## 従来方式（1回のAPI呼び出し）

### 生成されるもの：
- 問題文
- 図形描画プログラム（必要な場合）
- 解答・解説（テキスト形式）

### 問題点：
- トークン数制限により、長い問題では回答が途中で切れる
- 複雑な数値計算が必要な問題でも、計算過程が文章で説明されるだけ
- 図形と解答が同時生成されるため、整合性が取れない場合がある

### 今回の例で生成されたもの：
```
🔍 図形描画プログラム: ✅ 生成・実行済み（段階的料金体系のグラフ）
🔍 数値計算プログラム: ❌ 独立したプログラムとしては生成されていない
🔍 解答: ✅ テキスト形式で生成（1842文字）
```

## 2段階生成システム（高精度）

### 1回目のAPI呼び出し：
- **目的**: 問題文と図形の生成に特化
- **生成されるもの**:
  - 問題文（完全な問題として成立）
  - 図形描画プログラム（問題に特化したグラフや図形）

### 2回目のAPI呼び出し：
- **目的**: 解答手順と数値計算に特化
- **生成されるもの**:
  - 解答の手順（段階的な解法）
  - 数値計算プログラム（Pythonコード）
  - 最終解答（具体的な数値を含む）

### 期待される2段階生成の例：

#### 1回目で生成される図形描画プログラム：
```python
# 段階料金制度のグラフを描画
fig, ax = plt.subplots(1, 1, figsize=(10, 7))

# 各段階の電力量範囲
x1 = np.linspace(0, 120, 100)
x2 = np.linspace(120, 300, 100) 
x3 = np.linspace(300, 450, 100)

# 各段階の料金計算
y1 = 800 + 20 * x1
y2 = 800 + 20 * 120 + 25 * (x2 - 120)
y3 = 800 + 20 * 120 + 25 * 180 + 30 * (x3 - 300)

# グラフ描画とラベリング
ax.plot(x1, y1, 'b-', linewidth=2, label='Stage 1: 0-120kWh')
ax.plot(x2, y2, 'r-', linewidth=2, label='Stage 2: 120-300kWh')
ax.plot(x3, y3, 'g-', linewidth=2, label='Stage 3: 300+kWh')
```

#### 2回目で生成される数値計算プログラム：
```python
# 数値計算プログラム（各問題の計算）

# 問題(2): 250kWhの料金計算
usage_250 = 250
if usage_250 <= 120:
    cost_250 = 800 + 20 * usage_250
elif usage_250 <= 300:
    cost_250 = 800 + 20 * 120 + 25 * (usage_250 - 120)
else:
    cost_250 = 800 + 20 * 120 + 25 * 180 + 30 * (usage_250 - 300)

print(f"250kWhの料金: {cost_250}円")

# 問題(3): 400kWhの料金計算
usage_400 = 400
cost_400 = 800 + 20 * 120 + 25 * 180 + 30 * (usage_400 - 300)
print(f"400kWhの料金: {cost_400}円")

# 問題(4): 料金8300円から使用量を逆算
target_cost = 8300
# 各段階での最大料金
stage1_max = 800 + 20 * 120  # 3200円
stage2_max = stage1_max + 25 * 180  # 7700円

if target_cost <= stage1_max:
    usage = (target_cost - 800) / 20
elif target_cost <= stage2_max:
    usage = 120 + (target_cost - stage1_max) / 25
else:
    usage = 300 + (target_cost - stage2_max) / 30

print(f"8300円の使用量: {usage}kWh")

# 問題(5): 増加額の比較
cost_200 = 800 + 20 * 120 + 25 * (200 - 120)
cost_250 = 800 + 20 * 120 + 25 * (250 - 120)
increase_1 = cost_250 - cost_200

cost_350 = 800 + 20 * 120 + 25 * 180 + 30 * (350 - 300)
cost_400 = 800 + 20 * 120 + 25 * 180 + 30 * (400 - 300)
increase_2 = cost_400 - cost_350

print(f"200→250kWh増加額: {increase_1}円")
print(f"350→400kWh増加額: {increase_2}円")
print(f"大きいのは: {'350→400kWh' if increase_2 > increase_1 else '200→250kWh'}")
```

## 2段階生成の利点

1. **トークン制限対応**: 各段階を分けることで、長い問題でも完全な回答が生成される
2. **精度向上**: 図形生成と解答生成を分離することで、より正確な結果が得られる
3. **実行可能な計算**: 数値計算プログラムが独立して生成され、実際に実行可能
4. **ログ表示**: どのプログラムが生成されたか確認できる

## 使い分け

- **従来方式**: シンプルな問題、トークン制限に引っかからない場合
- **2段階生成**: 複雑な問題、数値計算が多い問題、図形と解答の両方が必要な場合
